# .github/workflows/security-audit.yml
# Automated security review on every PR

name: Security Audit & Code Quality

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Secret scanning
      - name: Scan for secrets (gitleaks)
        uses: gitleaks/gitleaks-action@v2
        with:
          verbose: true

      # SAST: OWASP Top 10 (Semgrep)
      - name: Security scanning (Semgrep)
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/owasp-top-ten
            p/security-audit
            p/ci/github-actions
          generateSarif: true
        continue-on-error: true

      # Dependency vulnerabilities
      - name: Check dependencies (Snyk)
        uses: snyk/actions/maven@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      # Upload SARIF results
      - name: Upload Semgrep results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: semgrep.sarif
        continue-on-error: true

  build-and-test:
    runs-on: ubuntu-latest
    needs: security-scan

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 23
        uses: actions/setup-java@v3
        with:
          java-version: '23'
          distribution: 'temurin'
          cache: maven

      # Compile check
      - name: Compile
        run: mvn clean compile -q

      # Run unit tests
      - name: Run tests
        run: mvn test -q

      # Code quality
      - name: Checkstyle
        run: mvn checkstyle:check -q

      # OWASP Dependency Check
      - name: OWASP Dependency Check
        run: |
          mvn org.owasp:dependency-check-maven:check \
            -Dformat=json \
            -DfailBuildOnCVSS=7.0
        continue-on-error: true

  comment-pr:
    runs-on: ubuntu-latest
    needs: [security-scan, build-and-test]
    if: github.event_name == 'pull_request'

    steps:
      - name: Comment PR with results
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');

            let comment = '## Security Audit Results\n\n';
            if (failedJobs.length === 0) {
              comment += '✅ All checks passed!\n';
            } else {
              comment += '⚠️ Issues found:\n';
              failedJobs.forEach(job => {
                comment += `- ${job.name}\n`;
              });
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
