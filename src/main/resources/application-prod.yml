# ============================================
# GOODFELLAZ17 - Production Configuration
# ============================================
# Activate: SPRING_PROFILES_ACTIVE=prod
#
# Database: Neon PostgreSQL (EU-Central-1 for Aachen latency)
# MontiCore SMI: Symbol Tables + CoCos enabled

spring:
  application:
    name: goodfellaz17-provider

  # Neon PostgreSQL R2DBC (EU-Central-1 for low latency)
  # Migration: Supabase → Neon (pg_dump restore)
  r2dbc:
    url: r2dbc:postgresql://${NEON_HOST:ep-xxx.eu-central-1.aws.neon.tech}:5432/${NEON_DB:goodfellaz17}?sslmode=require
    username: ${NEON_USER:goodfellaz17}
    password: ${NEON_PASSWORD}
    pool:
      initial-size: 5
      max-size: 20           # Neon connection pooling
      max-idle-time: 30m
      max-create-connection-time: 30s

  # JPA/Hibernate validation only (schema managed externally)
  jpa:
    hibernate:
      ddl-auto: validate

  # Async Task Execution
  task:
    execution:
      pool:
        core-size: 100
        max-size: 1000
        queue-capacity: 5000
      thread-name-prefix: bot-executor-

# ============================================
# MontiCore SMI Configuration (Lehrstuhl A+)
# ============================================
goodfellaz17:
  smi:
    enabled: true
    symboltable:
      cache-size: 1000           # Service lookup cache
      auto-populate: true        # Load services on startup
    cocos:
      order-quantity: true       # Min/max validation
      spotify-drip: true         # 5% spike prevention

# ============================================
# PRODUCTION GUARD RAILS - 15k Order Hardening
# ============================================
app:
  safety:
    maxConcurrentOrders: 15              # Circuit breaker threshold
    rateLimit:
      enabled: true
      ordersPerMinute: 15               # 15 orders per minute max
    minHealthyProxies: 20               # Alert if below this
    minHealthyAccounts: 300             # Alert if below this

  # Time compression DISABLED in production (1.0x multiplier)
  time:
    multiplier: 1.0

  # Failure injection DISABLED in production
  failureInjection:
    enabled: false

  # Metrics export
  metrics:
    prometheus:
      enabled: true
    export:
      interval: 60s

# ============================================
# Actuator - Disable chaos endpoints in prod
# ============================================
management:
  endpoints:
    web:
      exposure:
        include: health,metrics,prometheus,info
        exclude: env,configprops,chaosembeds

  # Prometheus scrape endpoint
  metrics:
    distribution:
      percentiles-histogram:
        delivery.latency: true
        task.execution.time: true
    tags:
      application: goodfellaz17
      environment: production
      api-key-balance: true      # Balance check
      track-url: true            # URL validation
    prettyprinter:
      enabled: true              # API documentation

  # ============================================
  # 15K DELIVERY SYSTEM - PRODUCTION CONFIGURATION
  # ============================================
  #
  # CRITICAL: These settings enforce production safety!
  # Time multiplier is 1 (REAL timing)
  # Chaos injection is BLOCKED
  #
  delivery:
    # NO time compression in production!
    time-multiplier: 1

    # Task sizing
    target-task-size: 400
    min-task-size: 300
    max-task-size: 500

    # Production thresholds
    orphan-threshold-seconds: 120     # 2 minutes
    retry-backoff-base-seconds: 30    # 30 second base
    max-retry-attempts: 3

  worker:
    # Production worker timing
    interval-ms: 10000                # Every 10 seconds
    batch-size: 50
    worker-id-prefix: "prod-worker"

  spotify:
    adapter: real                      # Use SpotifyRealAdapter (prod execution)
    timeout-seconds: 300               # 5 min per play
    max-retries: 3                     # Exponential backoff: 2s→4s→8s

  chaos:
    # CHAOS IS BLOCKED IN PRODUCTION
    available: false

  production-guards:
    # CRITICAL GUARDS - ALL TRUE IN PRODUCTION
    enforce-real-timing: true         # Blocks time compression
    block-chaos-injection: true       # Blocks failure injection
    require-ssl: true                 # Blocks non-HTTPS in prod
    min-delivery-window-hours: 24     # Minimum 24h delivery window

# ============================================
# Bot Executor Configuration
# ============================================
bot:
  executor:
    max-concurrent: 100
  stealth:
    enabled: true
  python:
    interpreter: python3
    script-path: src/main/python/SpotifyStealthScraper.py
    timeout-seconds: 180

# ============================================
# User Arbitrage Configuration
# ============================================
arbitrage:
  commission-rate: 0.30          # 30% to users
  batch-size: 100                # Plays per task
  task-timeout-seconds: 300      # 5 min task timeout
  rate-per-thousand: 0.50        # $0.50 per 1K plays

healthcheck:
  probes:
    enabled: true

metrics:
  export:
    prometheus:
      enabled: true
  tags:
    application: goodfellaz17
  distribution:
    percentiles-histogram:
      http.server.requests: true

# ============================================
# Logging (Production)
# ============================================
logging:
  level:
    root: INFO
    com.goodfellaz17: INFO
    com.goodfellaz17.symboltable: DEBUG
    com.goodfellaz17.cocos: DEBUG
    org.springframework.web: WARN
    org.springframework.security: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# ============================================
# Server Configuration
# ============================================
server:
  port: ${PORT:8080}
  compression:
    enabled: true
    mime-types: application/json,text/html
  error:
    include-message: never
    include-stacktrace: never
